<!DOCTYPE html>
<html>
<head>
    <title>MUN Admin Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .dashboard { 
            max-width: 1400px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 20px; 
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 { 
            color: #333; 
            margin-bottom: 30px;
            font-size: 2.5rem;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 10px 0;
        }
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        .tier-distribution {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        .tier-bar {
            display: flex;
            align-items: center;
            margin: 15px 0;
        }
        .tier-label {
            width: 80px;
            font-weight: bold;
        }
        .tier-progress {
            flex: 1;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 0 10px;
        }
        .tier-fill {
            height: 100%;
            display: flex;
            align-items: center;
            padding: 0 10px;
            color: white;
            font-weight: bold;
            transition: width 0.5s ease;
        }
        .tier1 { background: #ffd700; color: #000; }
        .tier2 { background: #c0c0c0; color: #000; }
        .tier3 { background: #cd7f32; }
        .tier4 { background: #4a90e2; }
        .tier5 { background: #7b68ee; }
        .tier6 { background: #95a5a6; }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
        }
        .status-allotted { background: #fff3cd; color: #856404; }
        .status-confirmed { background: #d4edda; color: #155724; }
        .status-waitlisted { background: #f8d7da; color: #721c24; }
        
        .refresh-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            margin-bottom: 20px;
        }
        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <h1>ðŸŽ¯ MUN Grand Prix Admin Dashboard</h1>
        
        <button class="refresh-btn" onclick="refreshData()">ðŸ”„ Refresh Data</button>
        
        <div class="stats-grid" id="statsGrid">
            <!-- Stats will be loaded here -->
        </div>
        
        <div class="tier-distribution">
            <h2>Portfolio Tier Distribution</h2>
            <div id="tierChart">
                <!-- Tier distribution will be loaded here -->
            </div>
        </div>
        
        <div>
            <h2>Recent Registrations</h2>
            <table id="registrationsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>School</th>
                        <th>Committee</th>
                        <th>Portfolio</th>
                        <th>Tier</th>
                        <th>Points</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="registrationsBody">
                    <!-- Registrations will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000/api';

        async function refreshData() {
            try {
                // Fetch statistics
                const statsRes = await fetch(`${API_URL}/statistics`);
                const statsData = await statsRes.json();
                
                // Fetch recent registrations
                const regsRes = await fetch(`${API_URL}/registrations`);
                const regsData = await regsRes.json();
                
                // Update stats grid
                const statsGrid = document.getElementById('statsGrid');
                const limits = statsData.data.limits;
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-label">Total Registrations</div>
                        <div class="stat-value">${limits.totalRegistrations}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Allotted (Max 25%)</div>
                        <div class="stat-value">${limits.allottedCount}/${limits.stats.allottedLimit}</div>
                        <div class="stat-label">${Math.round(limits.allottedPercentage)}%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Confirmed (Max 10%)</div>
                        <div class="stat-value">${limits.confirmedCount}/${limits.stats.confirmedLimit}</div>
                        <div class="stat-label">${Math.round(limits.confirmedPercentage)}%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Remaining Slots</div>
                        <div class="stat-value">${limits.stats.remainingAllotments}</div>
                    </div>
                `;
                
                // Update tier distribution
                const tierChart = document.getElementById('tierChart');
                const tierDist = statsData.data.tierDistribution;
                const maxCount = Math.max(...tierDist.map(t => t.count));
                
                tierChart.innerHTML = tierDist.map(tier => `
                    <div class="tier-bar">
                        <div class="tier-label">${tier._id?.toUpperCase() || 'N/A'}</div>
                        <div class="tier-progress">
                            <div class="tier-fill ${tier._id?.replace('tier', 'tier')}" 
                                 style="width: ${(tier.count / maxCount) * 100}%">
                                ${tier.count} (Avg: ${Math.round(tier.avgScore)}pts)
                            </div>
                        </div>
                    </div>
                `).join('');
                
                // Update registrations table
                const tbody = document.getElementById('registrationsBody');
                tbody.innerHTML = regsData.data.slice(0, 10).map(reg => `
                    <tr>
                        <td>${reg.registrationId}</td>
                        <td>${reg.name}</td>
                        <td>${reg.school}</td>
                        <td>${reg.allocation?.committee || '-'}</td>
                        <td>${reg.allocation?.portfolio || '-'}</td>
                        <td>${reg.allocation?.tier?.toUpperCase() || '-'}</td>
                        <td>${reg.points?.total || 0}</td>
                        <td><span class="status-badge status-${reg.status}">${reg.status.toUpperCase()}</span></td>
                    </tr>
                `).join('');
                
            } catch (error) {
                console.error('Error fetching data:', error);
                alert('Error loading dashboard data');
            }
        }

        // Load data on page load
        refreshData();
        
        // Auto-refresh every 30 seconds
        setInterval(refreshData, 30000);
    </script>
</body>
</html>